<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowVest - Invest in Sustainable Agriculture & Renewable Energy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js Library for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Montserrat:wght@400;500;700&display=swap');

        /* --- CSS Variables for easy theming --- */
        :root {
            --primary-color: #4CAF50; /* Green - for success, key actions */
            --primary-light: #66BB6A;
            --primary-dark: #388E3C;

            --secondary-color: #2196F3; /* Blue - for links, info */
            --secondary-light: #64B5F6;
            --secondary-dark: #1976D2;

            --dark-bg: #1A1A2E; /* Deep dark blue-purple for body background */
            --card-bg: #16213E; /* Slightly lighter dark for cards */
            --card-hover-bg: #1E2B4A; /* Even lighter for hover */

            --text-color: #E0E0E0; /* Light gray for general text */
            --light-text: #FFFFFF; /* White for headings, crucial info */
            --accent-color: #FFEB3B; /* Yellow for highlights, icons */
            --accent-light: #FFEE58;

            --error-color: #F44336; /* Red for errors */
            --success-color: #8BC34A; /* Light green for success */
            --info-color: #03A9F4; /* Light blue for info */

            --border-color: #3F4A6B; /* Border for subtle separation */
            --shadow-color-light: rgba(0, 0, 0, 0.2);
            --shadow-color-dark: rgba(0, 0, 0, 0.5);

            --gradient-bg: linear-gradient(135deg, var(--dark-bg) 0%, #0F1626 100%);
            --card-gradient-border: linear-gradient(45deg, var(--primary-color), var(--secondary-color));

            --hover-darken: rgba(0,0,0,0.1); /* For subtle hover backgrounds */
            
            /* Chart Colors - consistent with theme */
            --chart-line-color-1: #66BB6A; /* Primary Light */
            --chart-line-color-2: #64B5F6; /* Secondary Light */
            --chart-line-color-3: #FFEE58; /* Accent Light */
            --chart-line-color-4: #A064FF; /* Custom Purple */
            --chart-grid-color: rgba(63, 74, 107, 0.4); /* Border color, semi-transparent */
            --chart-text-color: #E0E0E0; /* Text color */
        }

        /* --- Base Styles --- */
        /* Universal Box-Sizing for predictable sizing - CRITICAL FOR RESPONSIVENESS */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--gradient-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow-x: hidden; /* Crucial: Prevent horizontal scroll by default */
            transition: background 0.5s ease-in-out;
            min-height: 100vh; /* Ensure full height for gradient */
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px; /* Consistent padding */
            width: 100%; /* Ensure it takes full width within its parent */
            flex-grow: 1; /* Allows container to push footer down */
        }

        /* --- Utility Classes (Mimicking Tailwind where useful) --- */
        .mt-12 { margin-top: 3rem; } /* 48px */
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mr-2 { margin-right: 0.5rem; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-white { color: var(--light-text); }
        .text-gray-300 { color: #C2C2C2; }
        .text-gray-400 { color: #A0A0A0; }
        .text-green-400 { color: var(--primary-light); }
        .text-purple-400 { color: #A064FF; /* Custom purple */ }
        .text-yellow-400 { color: var(--accent-light); }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .space-x-4 > *:not(:first-child) { margin-left: 1rem; }
        .space-y-2 > *:not(:first-child) { margin-top: 0.5rem; }
        .w-full { width: 100%; }
        .w-auto { width: auto; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-lg { box-shadow: 0 10px 25px -3px var(--shadow-color-dark), 0 4px 10px -2px var(--shadow-color-light); }


        /* --- Typography --- */
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--light-text);
            margin-bottom: 1rem;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-color);
        }

        a {
            color: var(--secondary-light);
            text-decoration: none;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        a:hover {
            color: var(--primary-light);
            text-shadow: 0 0 5px rgba(255,255,255,0.3);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px var(--shadow-color-light);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
            white-space: nowrap; /* Prevent text wrapping within button */
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            z-index: -1;
        }

        .btn:hover::before {
            transform: translateX(0);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow-color-dark);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-text);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--card-bg);
            color: var(--secondary-light);
            border: 1px solid var(--secondary-dark);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            color: var(--light-text);
            border-color: var(--secondary-light);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: var(--light-text);
        }

        .btn-danger:hover {
            background-color: #D32F2F; /* Slightly darker red */
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
            text-align: left; /* Align labels to left in modal */
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="email"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%; /* Now takes 100% and padding is included due to box-sizing */
            padding: 14px 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--card-bg);
            color: var(--light-text);
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            -webkit-appearance: none; /* Remove default styling for selects/inputs */
            -moz-appearance: none;
            appearance: none;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.4); /* Focus ring */
            background-color: var(--card-hover-bg);
        }
        
        /* Specific styling for select dropdown arrow */
        .form-group select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23E0E0E0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px; /* Make space for the arrow */
        }


        /* --- Messages --- */
        .message {
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            opacity: 1;
            transition: opacity 0.4s ease, height 0.4s ease, padding 0.4s ease, margin-bottom 0.4s ease;
            overflow: hidden; /* For height transition */
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            text-align: left; /* Align messages to left */
        }

        .message i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .message.hidden {
            opacity: 0;
            height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .message.success {
            background-color: rgba(139, 195, 74, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .message.error {
            background-color: rgba(244, 67, 54, 0.15);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .message.info {
            background-color: rgba(3, 169, 244, 0.15);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }

        /* --- Auth Layout --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--gradient-bg);
            padding: 20px; /* Add padding to prevent card touching edges on small screens */
        }

        .auth-card {
            background-color: var(--card-bg);
            padding: 45px;
            border-radius: 16px;
            box-shadow: 0 12px 40px var(--shadow-color-dark);
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .auth-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--card-gradient-border);
            z-index: -1;
            border-radius: 18px; /* Slightly larger for the border effect */
            filter: blur(10px);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .auth-card:hover::before {
            opacity: 0.6;
        }

        .auth-card:hover {
             transform: translateY(-8px);
             box-shadow: 0 18px 50px var(--shadow-color-dark);
        }

        .auth-card h2 {
            margin-bottom: 1.8rem;
            color: var(--light-text);
            font-size: 2.2rem;
            letter-spacing: -0.5px;
            text-shadow: 0 3px 8px rgba(0,0,0,0.5);
        }

        .auth-card p {
            margin-top: 1.2rem;
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .auth-card a {
            font-weight: 600;
        }

        /* --- Dashboard Header --- */
        .header {
            background-color: var(--card-bg);
            padding: 18px 30px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap; /* Allow wrapping on small screens */
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(8px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(8px);
            background-color: rgba(22, 33, 62, 0.8); /* Semi-transparent */
        }

        .header .logo {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-light);
            display: flex;
            align-items: center;
            letter-spacing: -1px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        .header .logo i {
            margin-right: 12px;
            color: var(--accent-light);
            font-size: 2.2rem;
        }

        .header nav {
            flex-grow: 1; /* Allow nav to take available space */
            text-align: center;
        }

        .header nav a, .header .user-menu button {
            color: var(--text-color);
            margin: 0 18px; /* Adjust margin for navigation items */
            font-weight: 600;
            transition: color 0.3s ease, transform 0.2s ease;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 1.05rem;
            padding: 8px 0; /* Add padding for click area */
            position: relative;
        }

        .header nav a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 3px;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            transition: width 0.3s ease-out;
            border-radius: 2px;
        }
        .header nav a:hover::after {
            width: 100%;
        }

        .header nav a:hover, .header .user-menu button:hover {
            color: var(--primary-light);
            transform: translateY(-2px);
        }

        .header .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px; /* Space between items */
        }

        .header .user-menu span {
            color: var(--accent-light);
            font-weight: 600;
            margin-right: 10px;
            display: none; /* Hidden by default for cleaner header on desktop, shown on hover/focus */
            transition: opacity 0.3s ease;
        }

        .header .user-menu:hover span, .header .user-menu:focus-within span {
            display: inline-block; /* Show on hover/focus within the menu */
            opacity: 1;
        }

        .header .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px var(--shadow-color-dark);
            z-index: 1000;
            min-width: 180px;
            padding: 10px 0;
            border: 1px solid var(--border-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        }

        .header .user-menu-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .header .user-menu-dropdown a, .header .user-menu-dropdown button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            text-align: left;
            color: var(--text-color);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.98rem;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .header .user-menu-dropdown a:hover, .header .user-menu-dropdown button:hover {
            background-color: var(--hover-darken); /* Or similar subtle background */
            color: var(--light-text);
        }

        /* --- Dashboard Sections --- */
        /* Main Grid Layout for Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default to single column on small screens */
            gap: 25px;
            margin-top: 35px;
        }

        /* Desktop Layout (2 columns) */
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 2fr 1fr; /* Main content wider than sidebar */
                grid-template-areas:
                    "portfolio portfolio"
                    "actions actions"
                    "chart investments"
                    "calculator calculator"
                    "highlights highlights";
            }
            .portfolio-overview { grid-area: portfolio; }
            .actions-grid { grid-area: actions; }
            .investment-performance-section { grid-area: chart; }
            .my-investments-section { grid-area: investments; }
            .calculator-section { grid-area: calculator; }
            .impact-highlights-section { grid-area: highlights; }
        }

        .portfolio-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .stat-card, .action-card, .calculator-section, .highlight-card, 
        .investment-performance-section, .my-investments-section {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 6px 25px var(--shadow-color-dark);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.4s ease, box-shadow 0.4s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before, .action-card::before, .calculator-section::before, .highlight-card::before,
        .investment-performance-section::before, .my-investments-section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--card-gradient-border);
            z-index: -1;
            border-radius: 18px; /* Slightly larger for the border effect */
            filter: blur(10px);
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .stat-card:hover::before, .action-card:hover::before, .calculator-section:hover::before, .highlight-card:hover::before,
        .investment-performance-section:hover::before, .my-investments-section:hover::before {
            opacity: 0.4;
        }


        .stat-card:hover, .action-card:hover, .highlight-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 35px var(--shadow-color-dark);
            background-color: var(--card-hover-bg);
        }


        .stat-card h3 {
            color: var(--primary-light);
            font-size: 1.3rem;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--light-text);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 3px 10px rgba(0,0,0,0.6);
        }

        .stat-card .description {
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .action-card h3 {
            color: var(--secondary-light);
            margin-bottom: 18px;
            font-size: 1.4rem;
            letter-spacing: 0.5px;
        }

        .action-card .icon {
            font-size: 3.5rem;
            color: var(--accent-light);
            margin-bottom: 25px;
            text-shadow: 0 0 15px var(--accent-light);
        }

        .action-card p {
            color: var(--text-color);
            margin-bottom: 25px;
            font-size: 0.98rem;
            line-height: 1.7;
        }

        /* --- Investment Calculator --- */
        .calculator-section {
            padding: 35px;
        }

        .calculator-section h2, .impact-highlights-section h2,
        .investment-performance-section h2, .my-investments-section h2 {
            text-align: center;
            color: var(--light-text);
            margin-bottom: 2rem;
            font-size: 2rem;
            letter-spacing: -0.5px;
            text-shadow: 0 3px 8px rgba(0,0,0,0.5);
        }

        .calculator-section .form-group {
            margin-bottom: 1.5rem;
        }

        .calculator-results {
            background-color: rgba(26, 42, 74, 0.5); /* Slightly different background for results */
            padding: 25px;
            border-radius: 12px;
            margin-top: 35px;
            border: 1px dashed var(--primary-light);
            box-shadow: inset 0 0 15px rgba(76, 175, 80, 0.2);
        }

        .calculator-results p {
            font-size: 1.15rem;
            margin-bottom: 0.9rem;
            color: var(--text-color);
        }

        .calculator-results p strong {
            color: var(--light-text);
            font-weight: 700;
        }

        .calculator-results .total-return {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-light);
            margin-top: 1.2rem;
            text-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        .calculator-results .profit {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-light);
            text-shadow: 0 0 5px rgba(255, 235, 59, 0.4);
        }

        /* --- Investment Performance Graph Section --- */
        .investment-performance-section {
            padding: 35px 20px;
            display: flex;
            flex-direction: column;
        }
        .investment-performance-section canvas {
            max-width: 100%;
            height: auto; /* Ensure canvas scales responsively */
        }

        /* --- My Active Investments Section --- */
        .my-investments-section {
            padding: 35px 20px;
        }

        .my-investments-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px; /* Limit height for scroll */
            overflow-y: auto; /* Enable scrolling for the list */
        }

        .my-investments-list::-webkit-scrollbar {
            width: 8px;
        }
        .my-investments-list::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 10px;
        }
        .my-investments-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }
        .my-investments-list::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-dark);
        }

        .investment-item {
            background-color: var(--card-hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .investment-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            background-color: rgba(30, 43, 74, 0.8); /* Slightly darker on hover */
        }
        
        .investment-item.highlighted {
            border-color: var(--primary-light);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            background-color: rgba(76, 175, 80, 0.1); /* Light green background */
        }

        .investment-item h4 {
            font-size: 1.15rem;
            color: var(--primary-light);
            margin-bottom: 5px;
        }

        .investment-item p {
            font-size: 0.9rem;
            color: var(--text-color);
            margin-bottom: 0;
        }

        .investment-item .value-current {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--light-text);
        }
        .investment-item .profit-loss {
            font-size: 1rem;
            font-weight: 600;
        }
        .investment-item .profit-loss.positive {
            color: var(--success-color);
        }
        .investment-item .profit-loss.negative {
            color: var(--error-color);
        }


        /* --- Impact & Sustainability Highlights --- */
        .impact-highlights-section {
            padding-bottom: 40px;
        }

        .impact-highlights-section p.intro-text {
            text-align: center;
            max-width: 800px;
            margin: 0 auto 40px auto;
            color: var(--text-color);
            font-size: 1.05rem;
            line-height: 1.8;
        }

        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 35px;
        }

        .highlight-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
            min-height: 200px; /* Ensure cards have some height */
        }

        .highlight-card .highlight-icon {
            font-size: 4rem;
            color: var(--primary-light);
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .highlight-card h4 {
            font-size: 1.5rem;
            color: var(--light-text);
            margin-bottom: 15px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            letter-spacing: -0.2px;
        }

        .highlight-card p {
            font-size: 0.95rem;
            color: var(--text-color);
            line-height: 1.7;
            flex-grow: 1; /* Allows text to take available space */
        }


        /* --- Footer --- */
        .footer {
            background-color: var(--card-bg);
            padding: 25px 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-color);
            font-size: 0.9rem;
            margin-top: auto; /* Pushes footer to the bottom */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 999; /* Ensure footer is above content if needed */
        }

        .footer p {
            margin: 0;
            color: var(--text-color);
        }

        .footer a {
            color: var(--primary-light);
            margin: 0 8px;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: 16px;
            box-shadow: 0 12px 40px var(--shadow-color-dark);
            width: 90%; /* Responsive width */
            max-width: 550px;
            text-align: center;
            border: 1px solid var(--border-color);
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease; /* Pop-in effect */
            position: relative;
            overflow: hidden;
            max-height: 90vh; /* Limit height for scrollable content */
            overflow-y: auto; /* Enable scrolling for taller modals */
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h3 {
            margin-bottom: 1.5rem;
            font-size: 2rem;
            color: var(--light-text);
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .modal-content p {
            font-size: 1.05rem;
            color: var(--text-color);
            line-height: 1.7;
        }

        .info-box {
            background-color: rgba(26, 42, 74, 0.5); /* Slightly different background for results */
            border: 1px dashed var(--secondary-light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            margin-bottom: 25px;
            text-align: left;
            box-shadow: inset 0 0 10px rgba(33, 150, 243, 0.2);
        }

        .info-box p {
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 0.98rem;
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }

        .info-box strong {
            color: var(--light-text);
            display: inline-block;
            min-width: 140px;
        }

        .account-number {
            font-family: 'Montserrat', monospace;
            color: var(--accent-light);
            font-weight: bold;
            user-select: all; /* Allow easy selection */
            font-size: 1.05rem;
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--secondary-light);
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.95rem;
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 5px 8px;
            border-radius: 5px;
        }
        .copy-btn:hover {
            color: var(--primary-light);
            transform: scale(1.1);
            background-color: rgba(76, 175, 80, 0.1);
        }
        .copy-btn i {
            margin-right: 5px;
        }

        .verification-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-left: 10px;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            vertical-align: middle; /* Align with label text */
            white-space: nowrap; /* Prevent status text from wrapping */
        }

        .verification-status.unverified {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
        }

        .verification-status.pending {
            background-color: rgba(255, 235, 59, 0.2);
            color: var(--accent-light);
        }

        .verification-status.verified {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--primary-light);
        }

        /* Simple loading animation for AI insight */
        .loading-text {
            position: relative;
            opacity: 0.8;
            min-height: 80px; /* Prevent content jump */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-direction: column; /* Allow spinner above text */
            gap: 15px;
            padding: 20px; /* Ensure content is within modal bounds */
        }

        .loading-text::after {
            content: ' .';
            animation: loading-dots 1s steps(5, end) infinite;
        }

        @keyframes loading-dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: var(--text-color);
                text-shadow:
                    .25em 0 0 var(--text-color),
                    .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow:
                    .25em 0 0 var(--text-color),
                    .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow:
                    .25em 0 0 var(--text-color),
                    .5em 0 0 var(--text-color);
            }
        }

        /* --- Modern Colorful Spinner Styles --- */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Slightly darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000; /* Above modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-light);
            border-left-color: var(--secondary-light);
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6), 0 0 20px rgba(33, 150, 243, 0.6);
            position: relative;
        }

        .spinner::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 6px solid rgba(255, 255, 255, 0.08);
            border-right-color: var(--accent-light);
            border-bottom-color: #A064FF; /* Custom purple for extra color */
            transform: translate(-50%, -50%);
            animation: spin-reverse 0.9s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin-reverse {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(-360deg); }
        }

        .spinner-text {
            color: var(--light-text);
            font-size: 1.6rem;
            font-weight: 600;
            margin-top: 25px;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            letter-spacing: 0.5px;
        }


        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 1024px) {
            .header nav a {
                margin: 0 12px;
            }
            .header .user-menu span {
                display: none; /* Hide welcome message on smaller desktops too */
            }
            .portfolio-overview, .actions-grid, .highlights-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Slightly smaller min-width */
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px; /* Reduce container padding */
            }
            .header {
                flex-direction: column;
                padding: 15px 20px;
                text-align: center;
            }

            .header .logo {
                margin-bottom: 15px;
                font-size: 1.7rem;
            }
            .header .logo i {
                font-size: 1.9rem;
            }

            .header nav {
                margin-top: 15px;
                width: 100%; /* Full width for nav */
                display: flex;
                justify-content: center;
                flex-wrap: wrap; /* Allow nav items to wrap */
                margin-bottom: 20px;
            }

            .header nav a, .header .user-menu button {
                margin: 0 8px 10px; /* Adjust margin for mobile nav */
                font-size: 0.95rem;
            }

            .header .user-menu {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
                gap: 20px;
            }
            .header .user-menu span {
                display: inline-block; /* Always show welcome message on mobile */
                font-size: 0.9rem;
            }

            .portfolio-overview, .actions-grid, .highlights-grid {
                grid-template-columns: 1fr; /* Stack columns on small screens */
                gap: 20px;
            }
            /* Ensure main dashboard grid stacks on mobile */
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-areas: none; /* Remove explicit areas for stacking */
            }

            .auth-card {
                padding: 35px 25px;
                margin: 0 10px; /* Reduced margin to maximize space */
                max-width: 360px;
            }
            .auth-card h2 {
                font-size: 1.9rem;
            }

            .modal-content {
                margin: 20px 15px; /* Adjust modal margin for smaller screens */
                padding: 30px 20px; /* Adjust modal padding */
                width: calc(100% - 30px); /* Fill space more effectively */
            }
            .modal-content h3 {
                font-size: 1.7rem;
            }
            
            /* Specific flex behavior for button groups in modals/forms */
            .flex-wrap.justify-center.space-x-2.space-y-2.sm\:space-y-0.sm\:space-x-4 > * {
                flex-basis: 100%; /* Make buttons full width on small screens */
                margin-left: 0 !important; /* Override space-x */
            }
            .flex-wrap.justify-center.space-x-2.space-y-2.sm\:space-y-0.sm\:space-x-4 button:not(:first-child) {
                margin-top: 10px; /* Add space between stacked buttons */
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px; /* Even tighter padding for very small screens */
            }
            .stat-card .value {
                font-size: 2.2rem;
            }

            .action-card .icon {
                font-size: 3rem;
            }

            .calculator-results .total-return {
                font-size: 1.6rem;
            }

            .calculator-results .profit {
                font-size: 1.3rem;
            }

            .auth-card h2 {
                font-size: 1.6rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .highlight-card .highlight-icon {
                font-size: 3.5rem;
            }
            .highlight-card h4 {
                font-size: 1.3rem;
            }
            .spinner {
                width: 60px;
                height: 60px;
                border-width: 6px;
            }
            .spinner::before {
                width: 45px;
                height: 45px;
                border-width: 5px;
            }
            .spinner-text {
                font-size: 1.2rem;
            }
            .info-box strong {
                min-width: 110px; /* Adjust min-width for labels in info box */
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Global Loading Spinner Overlay -->
    <div id="loadingSpinnerOverlay" class="spinner-overlay hidden">
        <div class="spinner-content flex flex-col items-center justify-center">
            <div class="spinner"></div>
            <div class="spinner-text" id="spinnerMessage">Processing...</div>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        const APP_ID = 'growvest-app'; // Unique ID for local storage keys
        // !! WARNING: For a real application, store your API key securely on a server !!
        // !! DO NOT expose it directly in client-side code in production !!
        const GEMINI_API_KEY = ""; // Replace with your actual Gemini API Key (e.g., 'YOUR_GEMINI_API_KEY')
        const MIN_INVESTMENT_AMOUNT = 50000; // Naira
        const MIN_WITHDRAWAL_AMOUNT = 10000; // Naira
        const SIMULATION_INTERVAL_MS = 5000; // Update graph every 5 seconds
        const MAX_HISTORICAL_POINTS = 100; // Max data points on the graph for performance

        // --- Global Chart Instance ---
        let investmentChart = null;
        const chartColors = [
            '#66BB6A', // primary-light
            '#64B5F6', // secondary-light
            '#FFEE58', // accent-light
            '#A064FF', // custom purple
            '#8BC34A', // success-color
            '#2196F3', // secondary-color
            '#FFEB3B', // accent-color
        ];
        let colorIndex = 0; // To cycle through colors for different lines

        // --- Helper Functions ---

        /**
         * Generates a unique ID.
         * @returns {string} A unique ID string.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /**
         * Formats a number as Naira currency.
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string (e.g., "₦100,000").
         */
        function formatNaira(amount) {
            return `₦${new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount)}`;
        }

        /**
         * Formats a Date object into a readable string.
         * @param {Date} date - The date object.
         * @returns {string} Formatted date string (e.g., "Jan 1, 2024 10:30 AM").
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                // Check if the date is valid
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                console.error("Error formatting date:", e, dateString);
                return 'N/A';
            }
        }


        /**
         * Displays a temporary message in a specified DOM element.
         * @param {HTMLElement} targetElement - The DOM element to display the message in.
         * @param {string} message - The message text.
         * @param {string} type - The message type ('success', 'error', 'info').
         * @param {string} iconClass - Font Awesome icon class (optional).
         */
        function displayMessage(targetElement, message, type, iconClass = '') {
            if (!targetElement) {
                console.error("Target element for message is null:", targetElement);
                return;
            }

            targetElement.innerHTML = iconClass ? `<i class="${iconClass}"></i> ${message}` : message;
            targetElement.className = `message ${type}`;
            targetElement.classList.remove('hidden');

            // Hide the message after a few seconds
            setTimeout(() => {
                targetElement.classList.add('hidden');
                // Clear content after transition for accessibility/screen readers
                setTimeout(() => targetElement.innerHTML = '', 400);
            }, 5000);
        }

        /**
         * Shows or hides the global loading spinner.
         * @param {boolean} show - True to show, false to hide.
         * @param {string} message - Optional message to display under the spinner.
         */
        function toggleSpinner(show, message = 'Processing...') {
            const spinnerOverlay = document.getElementById('loadingSpinnerOverlay');
            const spinnerMessage = document.getElementById('spinnerMessage');
            if (show) {
                spinnerMessage.textContent = message;
                spinnerOverlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent scrolling
            } else {
                spinnerOverlay.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        /**
         * Retrieves user authentication data (email, password, username).
         * @returns {object} An object mapping email to user credentials.
         */
        function getAuthUsers() {
            return JSON.parse(localStorage.getItem(`${APP_ID}-users`) || '{}');
        }

        /**
         * Saves user authentication data.
         * @param {object} authUsers - The object mapping email to user credentials.
         */
        function saveAuthUsers(authUsers) {
            localStorage.setItem(`${APP_ID}-users`, JSON.stringify(authUsers));
        }

        /**
         * Retrieves user profile data (balance, investments, verificationStatus, etc.).
         * @returns {object} An object mapping email to user profile data.
         */
        function getUsersData() {
            return JSON.parse(localStorage.getItem(`${APP_ID}-usersData`) || '{}');
        }

        /**
         * Saves user profile data.
         * @param {object} usersData - The object mapping email to user profile data.
         */
        function saveUsersData(usersData) {
            localStorage.setItem(`${APP_ID}-usersData`, JSON.stringify(usersData));
        }

        /**
         * Retrieves data for a specific user.
         * @param {string} email - The user's email.
         * @returns {object} User data object, or default if not found.
         */
        function getUserProfileData(email) {
            const usersData = getUsersData();
            // Default structure for new users or if data is missing
            return usersData[email] || {
                username: email.split('@')[0], // Default username from email
                email: email,
                balance: 0,
                totalInvested: 0, // This will be the sum of initial amounts of active investments
                estimatedTotalReturns: 0, // This will be the sum of (currentValue - initialAmount) of active investments
                verificationStatus: 'unverified',
                registrationDate: new Date().toISOString(), // Set on first access/creation
                lastLogin: null, // Set on first successful login
                activeInvestments: [] // New: Array to store active investment details
            };
        }

        /**
         * Updates and saves data for a specific user.
         * @param {string} oldEmail - The user's current (or old if changing) email.
         * @param {object} data - The user data object to save.
         */
        function updateUserProfileData(oldEmail, data) {
            let usersData = getUsersData();
            // If email is changing, delete old entry and create new one
            if (oldEmail && data.email && oldEmail !== data.email) {
                delete usersData[oldEmail];
                usersData[data.email] = data;
            } else {
                usersData[oldEmail] = data; // Update existing entry
            }
            saveUsersData(usersData);
        }

        /**
         * Copies text from a specified element to the clipboard.
         * @param {string} elementId - The ID of the element whose text content should be copied.
         */
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                const textToCopy = element.textContent;
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        alert('Account number copied to clipboard!'); // Simple alert for confirmation
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy. Please try manually.');
                    });
            }
        }

        /**
         * Toggles the visibility of a modal.
         * @param {HTMLElement} modalElement - The modal overlay element.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleModal(modalElement, show) {
            if (show) {
                modalElement.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
            } else {
                modalElement.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // --- Page Render Functions ---

        /**
         * Renders the Sign Up page.
         * @param {string} message - Optional message to display.
         * @param {string} type - Type of message ('success', 'error', 'info').
         */
        function renderSignUpPage(message = '', type = '', icon = '') {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="auth-container">
                    <div class="auth-card">
                        <h2>Join GrowVest</h2>
                        <div id="authMessage" class="message ${type} ${message ? '' : 'hidden'}">${icon ? `<i class="${icon}"></i> ` : ''}${message}</div>
                        <form id="signupForm">
                            <div class="form-group">
                                <label for="signupEmail">Email</label>
                                <input type="email" id="signupEmail" placeholder="Enter your email" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label for="signupUsername">Username</label>
                                <input type="text" id="signupUsername" placeholder="Choose a username (optional)" autocomplete="username">
                            </div>
                            <div class="form-group">
                                <label for="signupPassword">Password</label>
                                <input type="password" id="signupPassword" placeholder="Create a secure password" required autocomplete="new-password">
                            </div>
                            <button type="submit" class="btn btn-primary w-full mt-4">Sign Up</button>
                        </form>
                        <p>Already a member? <a href="#" id="showLogin">Log In</a></p>
                    </div>
                </div>
            `;
            // Attach event listeners after rendering
            document.getElementById('signupForm').addEventListener('submit', handleSignUp);
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('login');
            });
        }

        /**
         * Renders the Login page.
         * @param {string} message - Optional message to display.
         * @param {string} type - Type of message ('success', 'error', 'info').
         */
        function renderLoginPage(message = '', type = '', icon = '') {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = `
                <div class="auth-container">
                    <div class="auth-card">
                        <h2>Welcome Back!</h2>
                        <div id="authMessage" class="message ${type} ${message ? '' : 'hidden'}">${icon ? `<i class="${icon}"></i> ` : ''}${message}</div>
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="loginEmail">Email</label>
                                <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">Password</label>
                                <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
                            </div>
                            <button type="submit" class="btn btn-primary w-full mt-4">Login</button>
                        </form>
                        <p>New to GrowVest? <a href="#" id="showSignup">Sign Up</a></p>
                    </div>
                </div>
            `;
            // Attach event listeners after rendering
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('showSignup').addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('signup');
            });
        }

        /**
         * Renders the main Dashboard page.
         * @param {string} userEmail - The email of the logged-in user.
         */
        function renderDashboardPage(userEmail) {
            const appDiv = document.getElementById('app');
            const userData = getUserProfileData(userEmail);
            const displayUsername = userData.username || userEmail.split('@')[0]; // Fallback to email part for display

            appDiv.innerHTML = `
                <header class="header">
                    <div class="logo"><i class="fas fa-seedling"></i> GrowVest</div>
                    <nav>
                        <a href="#" id="dashboardNav">Dashboard</a>
                        <a href="#">Invest</a>
                        <a href="#">Portfolio</a>
                    </nav>
                    <div class="user-menu">
                        <span id="welcomeMessage">Welcome, ${displayUsername}!</span>
                        <button id="settingsButton" title="Settings"><i class="fas fa-cog"></i></button>
                        <button id="logoutButton" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </header>

                <main class="container">
                    <div class="dashboard-grid">
                        <section class="portfolio-overview">
                            <h3>Your Financial Overview</h3>
                            <div class="portfolio-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
                                <div class="stat-card">
                                    <h3>Current Balance</h3>
                                    <div class="value" id="displayBalance">₦0</div>
                                    <p class="description">Funds available for investment</p>
                                </div>
                                <div class="stat-card">
                                    <h3>Total Invested</h3>
                                    <div class="value" id="displayTotalInvested">₦0</div>
                                    <p class="description">Across all active projects</p>
                                </div>
                                <div class="stat-card">
                                    <h3>Estimated Returns</h3>
                                    <div class="value" id="displayEstimatedTotalReturns">₦0</div>
                                    <p class="description">Potential earnings on current investments</p>
                                </div>
                            </div>
                        </section>

                        <section class="actions-grid mt-12">
                            <div class="action-card">
                                <div class="icon"><i class="fas fa-piggy-bank"></i></div>
                                <h3>Add Funds</h3>
                                <p>Top up your GrowVest balance to seize new investment opportunities.</p>
                                <div class="form-group">
                                    <input type="number" id="addFundsAmount" placeholder="Amount (e.g., ₦50,000)" min="10000" required>
                                </div>
                                <button id="payInBtn" class="btn btn-primary w-full">Add Funds</button>
                                <div id="addFundsMessage" class="message hidden mt-4"></div>
                            </div>

                            <div class="action-card">
                                <div class="icon"><i class="fas fa-hand-holding-usd"></i></div>
                                <h3>Withdraw Funds</h3>
                                <p>Cash out your earnings or available balance to your bank account.</p>
                                <button id="withdrawBtn" class="btn btn-secondary w-full">Withdraw Funds</button>
                            </div>

                            <div class="action-card">
                                <div class="icon"><i class="fas fa-chart-area"></i></div>
                                <h3>Explore Investments</h3>
                                <p>Discover high-yield opportunities in sustainable sectors.</p>
                                <button class="btn btn-secondary w-full" id="marketInsightsBtn">Market Insights</button>
                            </div>

                            <div class="action-card">
                                <div class="icon"><i class="fas fa-user-friends"></i></div>
                                <h3>Refer & Earn</h3>
                                <p>Invite friends to GrowVest and earn exciting bonuses.</p>
                                <button class="btn btn-secondary w-full">Learn More</button>
                            </div>
                        </section>

                        <section class="investment-performance-section mt-12">
                            <h2><i class="fas fa-chart-line"></i> Investment Performance Graph</h2>
                            <p class="text-center text-gray-400 mb-4">Track the simulated growth and fluctuations of your active investments over time.</p>
                            <canvas id="investmentChart"></canvas>
                            <p class="text-center text-gray-400 text-sm mt-4">Note: This graph displays simulated market performance and is for illustrative purposes only.</p>
                        </section>

                        <section class="my-investments-section mt-12">
                            <h2><i class="fas fa-wallet"></i> My Active Investments</h2>
                            <p class="text-center text-gray-400 mb-4" id="noInvestmentsMessage">No active investments yet. Start investing to see them here!</p>
                            <ul id="myInvestmentsList" class="my-investments-list">
                                <!-- Active investments will be rendered here -->
                            </ul>
                        </section>

                        <section class="calculator-section mt-12">
                            <h2><i class="fas fa-calculator"></i> Grow Your Future: Investment Calculator</h2>
                            <div id="calculatorMessage" class="message hidden mb-4"></div>
                            <div class="form-group">
                                <label for="investmentAmount">Investment Amount (₦)</label>
                                <input type="number" id="investmentAmount" value="${MIN_INVESTMENT_AMOUNT}" min="${MIN_INVESTMENT_AMOUNT}" required>
                            </div>
                            <div class="form-group">
                                <label for="investmentOpportunity">Investment Opportunity</label>
                                <select id="investmentOpportunity">
                                    <option value="poultry" data-rate="2.50">Poultry Farming (250% Annually)</option>
                                    <option value="food" data-rate="2.20">Sustainable Food Cultivation (220% Annually)</option>
                                    <option value="aquaculture" data-rate="2.80">Aquaculture Projects (280% Annually)</option>
                                    <option value="energy" data-rate="2.30">Renewable Energy Solutions (230% Annually)</option>
                                    <option value="luxury_crops" data-rate="3.50">Luxury Crop Cultivation (350% Annually)</option>
                                    <option value="tech_agri" data-rate="4.00">Agri-Tech Innovations (400% Annually)</option>
                                </select>
                            </div>
                            <div class="form-group flex items-center space-x-4">
                                <div style="flex: 2;">
                                    <label for="investmentDurationValue">Duration</label>
                                    <input type="number" id="investmentDurationValue" value="1" min="1" required>
                                </div>
                                <div style="flex: 1;">
                                    <label for="investmentDurationUnit" class="hidden">Unit</label>
                                    <select id="investmentDurationUnit">
                                        <option value="years">Years</option>
                                        <option value="months">Months</option>
                                    </select>
                                </div>
                            </div>
                            <button id="calculateReturnsBtn" class="btn btn-primary w-full mt-4">Calculate Returns</button>

                            <div id="calculatorResults" class="calculator-results mt-6 hidden">
                                <p>Initial Investment: <strong id="displayInitialInvestment"></strong></p>
                                <p>Duration: <strong id="displayDurationValue"></strong> <span id="displayDurationUnit"></span></p>
                                <p>Opportunity: <strong id="displayOpportunity"></strong></p>
                                <p class="profit">Estimated Profit: <strong id="displayProfit"></strong></p>
                                <p class="total-return">Total Return: <strong id="displayTotalReturn"></strong></p>
                                <button id="proceedToInvestBtn" class="btn btn-primary mt-4 w-full">Proceed to Invest</button>
                            </div>
                        </section>

                        <!-- Impact & Sustainability Highlights Section -->
                        <section class="impact-highlights-section mt-12">
                            <h2><i class="fas fa-globe-americas"></i> Our Impact & Sustainability Highlights</h2>
                            <p class="intro-text">At GrowVest, we're not just growing wealth; we're cultivating a sustainable future. See the tangible impact of your investments and our commitment to positive change.</p>
                            <div class="highlights-grid">
                                <div class="highlight-card">
                                    <div class="highlight-icon"><i class="fas fa-tree"></i></div>
                                    <h4>Eco-Friendly Projects</h4>
                                    <p>Over <strong>2,500 hectares</strong> of sustainable farms and renewable energy sites funded globally.</p>
                                </div>
                                <div class="highlight-card">
                                    <div class="highlight-icon"><i class="fas fa-chart-line"></i></div>
                                    <h4>Consistent Growth</h4>
                                    <p>Achieving an average annual investor return of <strong>280% across all portfolios.</strong></p>
                                </div>
                                <div class="highlight-card">
                                    <div class="highlight-icon"><i class="fas fa-users"></i></div>
                                    <h4>Community Empowerment</h4>
                                    <p>Supporting <strong>10,000+ local farmers</strong> and generating rural employment opportunities.</p>
                                </div>
                                <div class="highlight-card">
                                    <div class="highlight-icon"><i class="fas fa-leaf"></i></div>
                                    <h4>Reduced Carbon Footprint</h4>
                                    <p>Contributing to a reduction of over <strong>50,000 tons of carbon emissions</strong> annually.</p>
                                </div>
                            </div>
                        </section>
                    </div>
                </main>

                <footer class="footer">
                    <div class="container">
                        <p>&copy; 2025 GrowVest. All rights reserved. | <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a></p>
                    </div>
                </footer>

                <!-- Modals -->
                <div id="investmentConfirmationModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-white mb-4">Confirm Your Investment</h3>
                        <p class="text-gray-300 mb-6">You are about to invest <span id="confirmInvestmentAmount" class="font-semibold text-green-400"></span> in <span id="confirmInvestmentType" class="font-semibold text-purple-400"></span> with an estimated annual return of <span id="confirmInvestmentRate" class="font-semibold text-green-400"></span>. Please review the details carefully.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="cancelInvestmentBtn" class="btn-secondary px-6 py-3 w-auto">Cancel</button>
                            <button id="confirmInvestmentBtn" class="btn-primary px-6 py-3 w-auto">Confirm & Invest</button>
                        </div>
                    </div>
                </div>

                <div id="paymentInstructionsModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-white mb-4">Add Funds Instructions</h3>
                        <p class="text-gray-300 mb-6">Please make a transfer of <span id="paymentAmount" class="font-semibold text-green-400"></span> to the account details below to top up your GrowVest balance:</p>
                        <div class="info-box">
                            <p><strong class="text-white">Bank Name:</strong> GrowVest Bank</p>
                            <p><strong class="text-white">Account Name:</strong> GrowVest Investments Ltd.</p>
                            <p><strong class="text-white">Account Number:</strong> <span id="accountNumber" class="account-number">1234567890</span> <button class="copy-btn" onclick="copyToClipboard('accountNumber')"><i class="fas fa-copy"></i> Copy</button></p>
                        </div>
                        <p class="text-gray-400 text-sm mb-6">Your balance will be updated upon successful confirmation of payment, typically within 2-4 hours.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="cancelPaymentInstructionsBtn" class="btn-secondary px-6 py-3 w-auto">Cancel</button>
                            <button id="confirmPaymentReceivedBtn" class="btn-primary px-6 py-3 w-auto">I Have Paid</button>
                        </div>
                    </div>
                </div>

                <div id="withdrawalModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-white mb-4">Withdraw Funds</h3>
                        <div id="withdrawalMessage" class="message hidden"></div>
                        <form id="withdrawalForm">
                            <div class="form-group">
                                <label for="withdrawalAmount">Amount (₦)</label>
                                <input type="number" id="withdrawalAmount" placeholder="Enter amount to withdraw" min="${MIN_WITHDRAWAL_AMOUNT}" required>
                            </div>
                            <div class="form-group">
                                <label for="bankName">Bank Name</label>
                                <input type="text" id="bankName" placeholder="e.g., GrowVest Bank" required autocomplete="organization">
                            </div>
                            <div class="form-group">
                                <label for="bankAccountNumber">Account Number</label>
                                <input type="text" id="bankAccountNumber" placeholder="Your bank account number" required autocomplete="cc-number">
                            </div>
                            <div class="flex flex-wrap justify-center space-x-2 space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                                <button type="button" id="cancelWithdrawalBtn" class="btn btn-secondary w-full sm:w-auto">Cancel</button>
                                <button type="submit" class="btn btn-primary w-full sm:w-auto">Submit Withdrawal</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="paymentSuccessModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-green-400 mb-4"><i class="fas fa-check-circle mr-2"></i> Transaction Successful!</h3>
                        <p class="text-gray-300 mb-6">Your <span id="successTransactionType" class="font-semibold text-purple-400"></span> has been processed successfully. Your balance and portfolio have been updated.</p>
                        <p class="text-gray-400 text-sm">You'll receive an email confirmation shortly.</p>
                        <button id="closeSuccessModalBtn" class="btn-primary mt-6 px-6 py-3 w-auto">Done</button>
                    </div>
                </div>

                <div id="aiInsightModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-white mb-4"><i class="fas fa-brain mr-2"></i> AI Insights for <span id="aiInsightTitle" class="text-yellow-400"></span></h3>
                        <div id="aiInsightContent" class="text-gray-300 mb-6 loading-text">
                            <div class="spinner small-spinner"></div> <!-- Small spinner for AI insight -->
                            Generating insightful analysis...
                        </div>
                        <button id="closeAiInsightModalBtn" class="btn-secondary px-6 py-3 w-auto">Close</button>
                    </div>
                </div>

                <div id="settingsModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-2xl font-bold text-white mb-4"><i class="fas fa-cog mr-2"></i> Profile Settings</h3>
                        <div id="settingsMessage" class="message hidden"></div>
                        <form id="settingsForm"> <!-- Wrapped settings inputs in a form -->
                            <div class="form-group">
                                <label for="settingsUsername">Username:</label>
                                <input type="text" id="settingsUsername" placeholder="Optional username" autocomplete="username">
                            </div>
                            <div class="form-group">
                                <label for="settingsEmail">Email:</label>
                                <input type="email" id="settingsEmail" placeholder="Your current email" autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label for="settingsNewPassword">New Password:</label>
                                <input type="password" id="settingsNewPassword" placeholder="Enter new password (min 6 chars)" autocomplete="new-password">
                            </div>
                             <div class="form-group">
                                <label for="settingsConfirmPassword">Confirm New Password:</label>
                                <input type="password" id="settingsConfirmPassword" placeholder="Confirm new password" autocomplete="new-password">
                            </div>
                            <div class="form-group flex justify-between items-center">
                                <label class="mb-0">Verification Status:</label>
                                <span id="verificationStatus" class="verification-status"></span>
                            </div>
                            <div class="form-group flex justify-between items-center">
                                <label class="mb-0">Registration Date:</label>
                                <span id="registrationDate" class="text-gray-300"></span>
                            </div>
                            <div class="form-group flex justify-between items-center mb-6">
                                <label class="mb-0">Last Login:</label>
                                <span id="lastLoginDate" class="text-gray-300"></span>
                            </div>
                            <div class="flex flex-wrap justify-center space-x-2 space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                                <button type="submit" id="updateProfileBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-save mr-2"></i> Save Changes</button>
                                <button type="button" id="initiateVerificationBtn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-user-check mr-2"></i> Initiate Verification</button>
                            </div>
                            <button type="button" id="closeSettingsModalBtn" class="btn btn-secondary mt-4 w-full">Close</button>
                        </form>
                    </div>
                </div>
            `;

            // --- Cache DOM Elements (Dashboard Scope) ---
            const logoutButton = document.getElementById('logoutButton');
            const settingsButton = document.getElementById('settingsButton');
            const welcomeMessageSpan = document.getElementById('welcomeMessage');

            const addFundsAmountInput = document.getElementById('addFundsAmount');
            const payInBtn = document.getElementById('payInBtn');
            const addFundsMessageDiv = document.getElementById('addFundsMessage');
            const marketInsightsBtn = document.getElementById('marketInsightsBtn');
            const withdrawBtn = document.getElementById('withdrawBtn'); // New: Withdrawal button

            const investmentAmountInput = document.getElementById('investmentAmount');
            const investmentDurationValueInput = document.getElementById('investmentDurationValue');
            const investmentDurationUnitSelect = document.getElementById('investmentDurationUnit');
            const investmentOpportunitySelect = document.getElementById('investmentOpportunity');
            const calculateReturnsBtn = document.getElementById('calculateReturnsBtn');
            const calculatorResultsDiv = document.getElementById('calculatorResults');
            const calculatorMessageDiv = document.getElementById('calculatorMessage');
            const proceedToInvestBtn = document.getElementById('proceedToInvestBtn');

            const displayInitialInvestment = document.getElementById('displayInitialInvestment');
            const displayDurationValue = document.getElementById('displayDurationValue');
            const displayDurationUnit = document.getElementById('displayDurationUnit');
            const displayOpportunity = document.getElementById('displayOpportunity');
            const displayTotalReturn = document.getElementById('displayTotalReturn');
            const displayProfit = document.getElementById('displayProfit');

            const displayBalance = document.getElementById('displayBalance');
            const displayTotalInvested = document.getElementById('displayTotalInvested');
            const displayEstimatedTotalReturns = document.getElementById('displayEstimatedTotalReturns');

            const investmentConfirmationModal = document.getElementById('investmentConfirmationModal');
            const confirmInvestmentAmount = document.getElementById('confirmInvestmentAmount');
            const confirmInvestmentType = document.getElementById('confirmInvestmentType');
            const confirmInvestmentRate = document.getElementById('confirmInvestmentRate');
            const cancelInvestmentBtn = document.getElementById('cancelInvestmentBtn');
            const confirmInvestmentBtn = document.getElementById('confirmInvestmentBtn');

            const paymentInstructionsModal = document.getElementById('paymentInstructionsModal');
            const paymentAmountSpan = document.getElementById('paymentAmount');
            const cancelButtonPaymentInstructionsBtn = document.getElementById('cancelPaymentInstructionsBtn');
            const confirmPaymentReceivedBtn = document.getElementById('confirmPaymentReceivedBtn');

            const withdrawalModal = document.getElementById('withdrawalModal'); // New: Withdrawal modal
            const withdrawalForm = document.getElementById('withdrawalForm'); // New: Withdrawal form
            const withdrawalAmountInput = document.getElementById('withdrawalAmount'); // New: Withdrawal amount input
            const bankNameInput = document.getElementById('bankName'); // New: Bank name input
            const bankAccountNumberInput = document.getElementById('bankAccountNumber'); // New: Bank account number input
            const cancelWithdrawalBtn = document.getElementById('cancelWithdrawalBtn'); // New: Cancel withdrawal button
            const withdrawalMessageDiv = document.getElementById('withdrawalMessage'); // New: Withdrawal message div

            const paymentSuccessModal = document.getElementById('paymentSuccessModal');
            const successTransactionTypeSpan = document.getElementById('successTransactionType');
            const closeSuccessModalBtn = document.getElementById('closeSuccessModalBtn');

            const aiInsightModal = document.getElementById('aiInsightModal');
            const aiInsightTitle = document.getElementById('aiInsightTitle');
            const aiInsightContent = document.getElementById('aiInsightContent');
            const closeAiInsightModalBtn = document.getElementById('closeAiInsightModalBtn');

            const settingsModal = document.getElementById('settingsModal');
            const settingsForm = document.getElementById('settingsForm'); // New: Settings form
            const settingsUsernameInput = document.getElementById('settingsUsername');
            const settingsEmailInput = document.getElementById('settingsEmail');
            const settingsNewPasswordInput = document.getElementById('settingsNewPassword');
            const settingsConfirmPasswordInput = document.getElementById('settingsConfirmPassword');
            const verificationStatusSpan = document.getElementById('verificationStatus');
            const registrationDateSpan = document.getElementById('registrationDate');
            const lastLoginDateSpan = document.getElementById('lastLoginDate');
            const updateProfileBtn = document.getElementById('updateProfileBtn');
            const initiateVerificationBtn = document.getElementById('initiateVerificationBtn');
            const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
            const settingsMessageDiv = document.getElementById('settingsMessage');

            // New: Chart related elements
            const investmentChartCanvas = document.getElementById('investmentChart');
            const myInvestmentsList = document.getElementById('myInvestmentsList');
            const noInvestmentsMessage = document.getElementById('noInvestmentsMessage');

            // --- State Variables ---
            let currentInvestmentDetails = {}; // Stores details of the last calculated investment
            let currentAddFundsAmount = 0; // Stores the amount for the add funds flow
            let simulationIntervalId = null; // To store the interval ID for clearing

            // --- Chart Functions ---
            /**
             * Initializes the Chart.js graph.
             */
            function initializeInvestmentChart() {
                if (investmentChart) {
                    investmentChart.destroy(); // Destroy existing chart if any
                }

                investmentChart = new Chart(investmentChartCanvas, {
                    type: 'line',
                    data: {
                        labels: [], // Will be dates
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'var(--chart-text-color)',
                                    font: {
                                        family: 'Poppins'
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += formatNaira(context.raw);
                                        return label;
                                    },
                                    title: function(context) {
                                        return formatDate(context[0].label);
                                    }
                                },
                                backgroundColor: 'var(--card-bg)',
                                titleColor: 'var(--light-text)',
                                bodyColor: 'var(--text-color)',
                                borderColor: 'var(--border-color)',
                                borderWidth: 1,
                                borderRadius: 8,
                                displayColors: true,
                                boxPadding: 4,
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute', // Could be 'hour', 'day', etc. depending on simulation speed
                                    tooltipFormat: 'MMM d, h:mm a',
                                    displayFormats: {
                                        minute: 'h:mm a',
                                        hour: 'h:mm a',
                                        day: 'MMM d'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time',
                                    color: 'var(--chart-text-color)',
                                    font: { family: 'Poppins', size: 14 }
                                },
                                ticks: {
                                    color: 'var(--chart-text-color)',
                                    font: { family: 'Poppins' }
                                },
                                grid: {
                                    color: 'var(--chart-grid-color)',
                                    borderColor: 'var(--chart-grid-color)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Value (₦)',
                                    color: 'var(--chart-text-color)',
                                    font: { family: 'Poppins', size: 14 }
                                },
                                ticks: {
                                    color: 'var(--chart-text-color)',
                                    font: { family: 'Poppins' },
                                    callback: function(value) {
                                        return formatNaira(value);
                                    }
                                },
                                grid: {
                                    color: 'var(--chart-grid-color)',
                                    borderColor: 'var(--chart-grid-color)'
                                }
                            }
                        }
                    }
                });
            }

            /**
             * Updates the Chart.js graph with current investment data.
             */
            function updateInvestmentGraph() {
                if (!investmentChart) {
                    initializeInvestmentChart();
                }

                const userData = getUserProfileData(userEmail);
                const datasets = [];
                const allLabels = new Set(); // Use a Set to collect unique timestamps

                userData.activeInvestments.forEach((investment, index) => {
                    const lineColor = chartColors[index % chartColors.length];
                    const dataPoints = investment.historicalData.map(point => {
                        allLabels.add(point.date); // Collect all dates
                        return { x: point.date, y: point.value };
                    });

                    datasets.push({
                        label: investment.type,
                        data: dataPoints,
                        borderColor: lineColor,
                        backgroundColor: lineColor + '33', // Semi-transparent fill
                        borderWidth: 2,
                        pointRadius: 0, // Hide individual points
                        fill: false, // No fill under the line
                        tension: 0.1, // Smoothness of the line
                        hidden: investment.hiddenOnGraph || false // Allow hiding specific lines
                    });
                });

                // Sort labels chronologically
                const sortedLabels = Array.from(allLabels).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());

                investmentChart.data.labels = sortedLabels;
                investmentChart.data.datasets = datasets;
                investmentChart.update();
            }

            /**
             * Renders the list of active investments.
             */
            function renderActiveInvestments() {
                const userData = getUserProfileData(userEmail);
                myInvestmentsList.innerHTML = ''; // Clear existing list

                if (userData.activeInvestments && userData.activeInvestments.length > 0) {
                    noInvestmentsMessage.classList.add('hidden');
                    userData.activeInvestments.forEach(investment => {
                        const profitLoss = investment.currentValue - investment.initialAmount;
                        const profitLossClass = profitLoss >= 0 ? 'positive' : 'negative';
                        const profitLossSign = profitLoss >= 0 ? '+' : '';

                        const listItem = document.createElement('li');
                        listItem.className = 'investment-item';
                        listItem.dataset.investmentId = investment.id; // Store ID for highlighting
                        listItem.innerHTML = `
                            <h4>${investment.type}</h4>
                            <p>Initial: <strong>${formatNaira(investment.initialAmount)}</strong></p>
                            <p>Current Value: <span class="value-current">${formatNaira(investment.currentValue)}</span></p>
                            <p>Profit/Loss: <span class="profit-loss ${profitLossClass}">${profitLossSign}${formatNaira(profitLoss)}</span></p>
                            <p>Duration: ${investment.durationMonths} months</p>
                            <p>Started: ${formatDate(investment.startDate)}</p>
                        `;
                        listItem.addEventListener('click', () => highlightInvestmentOnGraph(investment.id));
                        myInvestmentsList.appendChild(listItem);
                    });
                } else {
                    noInvestmentsMessage.classList.remove('hidden');
                }
            }

            /**
             * Highlights an investment on the graph when its list item is clicked.
             * @param {string} id - The ID of the investment to highlight.
             */
            function highlightInvestmentOnGraph(id) {
                // Remove highlight from all items
                document.querySelectorAll('.investment-item').forEach(item => {
                    item.classList.remove('highlighted');
                });

                // Add highlight to the clicked item
                const clickedItem = document.querySelector(`.investment-item[data-investment-id="${id}"]`);
                if (clickedItem) {
                    clickedItem.classList.add('highlighted');
                }

                // Update chart visibility
                if (investmentChart) {
                    investmentChart.data.datasets.forEach(dataset => {
                        // Hide all datasets initially
                        dataset.hidden = true;
                    });

                    // Find the dataset corresponding to the clicked investment and make it visible
                    const targetDataset = investmentChart.data.datasets.find(dataset => dataset.label === clickedItem.querySelector('h4').textContent);
                    if (targetDataset) {
                        targetDataset.hidden = false;
                    }
                    investmentChart.update();
                }
            }


            /**
             * Simulates the growth and fluctuation of active investments.
             */
            function simulateInvestmentGrowth() {
                let userData = getUserProfileData(userEmail);
                let totalEstimatedReturns = 0;
                let totalInvestedAmount = 0;

                userData.activeInvestments.forEach(investment => {
                    // Calculate daily growth based on annual rate
                    const dailyRate = investment.annualRate / 365; // Convert annual to daily
                    // Add a random fluctuation (e.g., +/- 0.5% of the daily growth)
                    const fluctuation = (Math.random() * 0.01 - 0.005); // Random value between -0.005 and +0.005
                    const effectiveDailyRate = dailyRate + fluctuation;

                    investment.currentValue *= (1 + effectiveDailyRate);

                    // Ensure value doesn't drop below 50% of initial amount (simple floor)
                    investment.currentValue = Math.max(investment.currentValue, investment.initialAmount * 0.5);

                    // Add new data point
                    investment.historicalData.push({
                        date: new Date().toISOString(),
                        value: investment.currentValue
                    });

                    // Keep historical data manageable
                    if (investment.historicalData.length > MAX_HISTORICAL_POINTS) {
                        investment.historicalData.shift(); // Remove oldest point
                    }

                    totalEstimatedReturns += (investment.currentValue - investment.initialAmount);
                    totalInvestedAmount += investment.initialAmount; // Sum of initial amounts
                });

                userData.estimatedTotalReturns = totalEstimatedReturns;
                userData.totalInvested = totalInvestedAmount; // Update total invested based on active investments

                updateUserProfileData(userEmail, userData);
                updatePortfolioOverview();
                updateInvestmentGraph();
                renderActiveInvestments(); // Re-render list to show updated values
            }

            // --- Functions (specific to Dashboard) ---

            /**
             * Updates the financial overview cards on the dashboard.
             */
            function updatePortfolioOverview() {
                const updatedUserData = getUserProfileData(userEmail); // Use userEmail for data retrieval
                displayBalance.textContent = formatNaira(updatedUserData.balance);
                displayTotalInvested.textContent = formatNaira(updatedUserData.totalInvested);
                displayEstimatedTotalReturns.textContent = formatNaira(updatedUserData.estimatedTotalReturns);
            }

            /**
             * Handles the "Add Funds" button click, showing the payment instructions modal.
             */
            const handleAddFunds = () => {
                const amount = parseFloat(addFundsAmountInput.value);
                if (isNaN(amount) || amount < 10000) { // Enforce a minimum add funds amount
                    displayMessage(addFundsMessageDiv, `Please enter a valid amount (minimum ${formatNaira(10000)}).`, 'error', 'fas fa-exclamation-triangle');
                    return;
                }
                displayMessage(addFundsMessageDiv, '', 'hidden'); // Clear previous message

                currentAddFundsAmount = amount;
                paymentAmountSpan.textContent = formatNaira(amount);
                toggleModal(paymentInstructionsModal, true);
            };

            /**
             * Handles the "Withdraw Funds" button click, showing the withdrawal modal.
             */
            const handleWithdrawalClick = () => {
                // Clear previous messages and inputs when opening
                displayMessage(withdrawalMessageDiv, '', 'hidden');
                withdrawalAmountInput.value = '';
                bankNameInput.value = '';
                bankAccountNumberInput.value = '';
                toggleModal(withdrawalModal, true);
            };

            /**
             * Handles the submission of the withdrawal form.
             */
            const handleWithdrawal = (event) => {
                event.preventDefault(); // Prevent default form submission

                const amount = parseFloat(withdrawalAmountInput.value);
                const bankName = bankNameInput.value.trim();
                const bankAccountNumber = bankAccountNumberInput.value.trim();
                const userData = getUserProfileData(userEmail);

                if (isNaN(amount) || amount < MIN_WITHDRAWAL_AMOUNT) {
                    displayMessage(withdrawalMessageDiv, `Please enter a valid amount (minimum ${formatNaira(MIN_WITHDRAWAL_AMOUNT)}).`, 'error', 'fas fa-exclamation-triangle');
                    return;
                }
                if (amount > userData.balance) {
                    displayMessage(withdrawalMessageDiv, `Insufficient balance. Your current balance is ${formatNaira(userData.balance)}.`, 'error', 'fas fa-wallet');
                    return;
                }
                if (!bankName || !bankAccountNumber) {
                    displayMessage(withdrawalMessageDiv, 'Please fill in all bank details.', 'error', 'fas fa-exclamation-triangle');
                    return;
                }
                if (bankAccountNumber.length < 10 || !/^\d+$/.test(bankAccountNumber)) {
                    displayMessage(withdrawalMessageDiv, 'Please enter a valid 10-digit account number.', 'error', 'fas fa-exclamation-triangle');
                    return;
                }

                // Simulate withdrawal success
                userData.balance -= amount;
                updateUserProfileData(userEmail, userData);
                updatePortfolioOverview(); // Refresh dashboard stats

                toggleModal(withdrawalModal, false);
                successTransactionTypeSpan.textContent = `withdrawal of ${formatNaira(amount)}`;
                toggleModal(paymentSuccessModal, true); // Re-using success modal for withdrawal
            };

            /**
             * Calculates and displays estimated investment returns based on user input.
             */
            function calculateReturns() {
                const amount = parseFloat(investmentAmountInput.value);
                let duration = parseFloat(investmentDurationValueInput.value);
                const durationUnit = investmentDurationUnitSelect.value;
                const selectedOption = investmentOpportunitySelect.options[investmentOpportunitySelect.selectedIndex];
                const opportunityText = selectedOption.text;
                const annualRate = parseFloat(selectedOption.dataset.rate);

                // Validation
                if (isNaN(amount) || amount < MIN_INVESTMENT_AMOUNT) {
                    displayMessage(calculatorMessageDiv, `Investment amount must be at least ${formatNaira(MIN_INVESTMENT_AMOUNT)}.`, 'error', 'fas fa-exclamation-circle');
                    calculatorResultsDiv.classList.add('hidden');
                    return;
                }
                if (isNaN(duration) || duration <= 0) {
                    displayMessage(calculatorMessageDiv, 'Please enter a valid positive number for investment duration.', 'error', 'fas fa-exclamation-circle');
                    calculatorResultsDiv.classList.add('hidden');
                    return;
                }

                displayMessage(calculatorMessageDiv, '', 'hidden'); // Clear previous message

                // Convert duration to years for calculation
                let durationInYears = duration;
                if (durationUnit === 'months') {
                    durationInYears = duration / 12;
                }

                // Simple interest calculation
                const totalReturn = amount * (1 + (annualRate * durationInYears));
                const profit = totalReturn - amount;

                displayInitialInvestment.textContent = formatNaira(amount);
                displayDurationValue.textContent = duration;
                displayDurationUnit.textContent = durationUnit;
                displayOpportunity.textContent = opportunityText.split('(')[0].trim(); // Clean up text for display
                displayTotalReturn.textContent = formatNaira(totalReturn);
                displayProfit.textContent = formatNaira(profit);

                calculatorResultsDiv.classList.remove('hidden');

                // Store details for later use in confirmation/investment flow
                currentInvestmentDetails = {
                    amount: amount,
                    type: opportunityText.split('(')[0].trim(),
                    rate: annualRate * 100, // Convert back to percentage for display
                    annualRate: annualRate, // Keep raw annual rate for simulation
                    durationMonths: (durationUnit === 'years' ? duration * 12 : duration), // Store duration in months
                    estimatedProfit: profit
                };
            }

            /**
             * Handles the "Proceed to Invest" button click, showing the confirmation modal.
             */
            const handleProceedToInvest = () => {
                const userData = getUserProfileData(userEmail); // Use userEmail for data retrieval
                if (currentInvestmentDetails.amount > userData.balance) {
                    displayMessage(calculatorMessageDiv, 'Insufficient balance. Please add funds to your GrowVest balance first.', 'error', 'fas fa-wallet');
                    return;
                } else {
                    displayMessage(calculatorMessageDiv, '', 'hidden'); // Clear message if sufficient funds
                }

                confirmInvestmentAmount.textContent = formatNaira(currentInvestmentDetails.amount);
                confirmInvestmentType.textContent = currentInvestmentDetails.type;
                confirmInvestmentRate.textContent = `${currentInvestmentDetails.rate}% Annually`;
                toggleModal(investmentConfirmationModal, true);
            };

            /**
             * Handles the final confirmation of an investment.
             */
            const handleConfirmInvestment = () => {
                toggleModal(investmentConfirmationModal, false);

                let userData = getUserProfileData(userEmail); // Use userEmail for data retrieval

                // Deduct from balance
                userData.balance -= currentInvestmentDetails.amount;

                // Create new active investment object
                const newInvestment = {
                    id: generateUniqueId(),
                    type: currentInvestmentDetails.type,
                    initialAmount: currentInvestmentDetails.amount,
                    currentValue: currentInvestmentDetails.amount, // Starts at initial amount
                    annualRate: currentInvestmentDetails.annualRate,
                    durationMonths: currentInvestmentDetails.durationMonths,
                    startDate: new Date().toISOString(),
                    endDate: new Date(new Date().setMonth(new Date().getMonth() + currentInvestmentDetails.durationMonths)).toISOString(),
                    historicalData: [{ date: new Date().toISOString(), value: currentInvestmentDetails.amount }],
                    status: 'active'
                };

                // Add to active investments
                userData.activeInvestments.push(newInvestment);

                // Recalculate total invested and estimated total returns from active investments
                userData.totalInvested = userData.activeInvestments.reduce((sum, inv) => sum + inv.initialAmount, 0);
                userData.estimatedTotalReturns = userData.activeInvestments.reduce((sum, inv) => sum + (inv.currentValue - inv.initialAmount), 0);

                updateUserProfileData(userEmail, userData); // Save updated user data
                updatePortfolioOverview(); // Refresh dashboard stats
                renderActiveInvestments(); // Update the list of investments
                updateInvestmentGraph(); // Update the graph with the new investment

                successTransactionTypeSpan.textContent = `investment in ${currentInvestmentDetails.type}`;
                toggleModal(paymentSuccessModal, true);
            };

            /**
             * Fetches and displays AI insights for a given investment type.
             * @param {string} investmentType - The type of investment to get insights for.
             */
            async function showAiInsightModal(investmentType) {
                aiInsightTitle.textContent = investmentType;
                aiInsightContent.innerHTML = `<div class="spinner small-spinner"></div> Generating insightful analysis...`; // Set spinner
                aiInsightContent.classList.add('loading-text');
                toggleModal(aiInsightModal, true);

                if (!GEMINI_API_KEY || GEMINI_API_KEY === "") {
                    aiInsightContent.innerHTML = 'Gemini API Key is not configured. AI insights will not work in this simulation.';
                    aiInsightContent.classList.remove('loading-text');
                    console.error('GEMINI_API_KEY is not set. AI insights will not work.');
                    return;
                }

                const prompt = `Provide a concise, positive, and informative summary (under 150 words) of the key benefits and growth potential for investing in "${investmentType}" within the sustainable agriculture or renewable energy sector, from the perspective of an investment platform.`;

                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Gemini API Error Response:', errorData);
                        throw new Error(`API error: ${response.status} - ${errorData.error ? errorData.error.message : response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        aiInsightContent.textContent = text;
                    } else {
                        aiInsightContent.textContent = 'Failed to generate insights. Unexpected API response structure.';
                        console.warn('Gemini API response structure unexpected:', result);
                    }
                } catch (error) {
                    aiInsightContent.textContent = `Error generating insights: ${error.message}. Please try again later.`;
                    console.error('Error calling Gemini API:', error);
                } finally {
                    aiInsightContent.classList.remove('loading-text');
                }
            }

            /**
             * Displays the settings modal with current user profile information.
             */
            function showSettingsModal() {
                const userData = getUserProfileData(userEmail); // Use userEmail for data retrieval
                settingsUsernameInput.value = userData.username || '';
                settingsEmailInput.value = userData.email || '';
                settingsNewPasswordInput.value = ''; // Clear password fields on open
                settingsConfirmPasswordInput.value = ''; // Clear password fields on open
                updateVerificationStatusDisplay(userData.verificationStatus);
                registrationDateSpan.textContent = formatDate(userData.registrationDate);
                lastLoginDateSpan.textContent = formatDate(userData.lastLogin);

                displayMessage(settingsMessageDiv, '', 'hidden'); // Clear previous messages
                toggleModal(settingsModal, true);
            }

            /**
             * Updates the display of the user's verification status.
             * @param {string} status - The verification status ('unverified', 'pending', 'verified').
             */
            function updateVerificationStatusDisplay(status) {
                verificationStatusSpan.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                verificationStatusSpan.className = `verification-status ${status}`;
            }

            /**
             * Handles updating the user's profile information (username, email, password).
             */
            const handleUpdateProfile = (event) => {
                event.preventDefault(); // Prevent default form submission

                let currentAuthUsers = getAuthUsers();
                let currentUserProfile = getUserProfileData(userEmail); // Get current profile data
                let oldEmail = userEmail; // Store current email for potential change

                const newUsername = settingsUsernameInput.value.trim();
                const newEmail = settingsEmailInput.value.trim().toLowerCase();
                const newPassword = settingsNewPasswordInput.value.trim();
                const confirmPassword = settingsConfirmPasswordInput.value.trim();

                // Validate new email if it's being changed
                if (newEmail && newEmail !== oldEmail) {
                    if (!/\S+@\S+\.\S+/.test(newEmail)) {
                        displayMessage(settingsMessageDiv, 'Please enter a valid new email address.', 'error', 'fas fa-exclamation-triangle');
                        return;
                    }
                    if (currentAuthUsers[newEmail] && newEmail !== oldEmail) { // Ensure it's not the current user's email itself
                        displayMessage(settingsMessageDiv, 'This new email is already registered to another account.', 'error', 'fas fa-exclamation-triangle');
                        return;
                    }
                }

                // Validate new password if it's being changed
                if (newPassword) {
                    if (newPassword.length < 6) {
                        displayMessage(settingsMessageDiv, 'New password must be at least 6 characters long.', 'error', 'fas fa-exclamation-triangle');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        displayMessage(settingsMessageDiv, 'New password and confirmation do not match.', 'error', 'fas fa-exclamation-triangle');
                        return;
                    }
                }

                let needsRelogin = false;

                // Update username in profile data
                currentUserProfile.username = newUsername;
                welcomeMessageSpan.textContent = `Welcome, ${newUsername || userEmail.split('@')[0]}!`; // Update welcome message immediately

                // Handle email change logic
                if (newEmail && newEmail !== oldEmail) {
                    const authUser = { ...currentAuthUsers[oldEmail] }; // Copy auth data
                    delete currentAuthUsers[oldEmail]; // Remove old entry from auth
                    authUser.email = newEmail; // Update email in auth record
                    currentAuthUsers[newEmail] = authUser; // Add new entry to auth

                    // Also update the email in the current profile data object
                    currentUserProfile.email = newEmail;

                    localStorage.setItem(`${APP_ID}-loggedInUserEmail`, newEmail); // Update logged in email
                    userEmail = newEmail; // Update the userEmail variable in this scope for immediate use
                    needsRelogin = true;
                }

                // Handle password change logic
                if (newPassword) {
                    // Update password for the user in auth data (using the potentially new userEmail)
                    currentAuthUsers[userEmail].password = newPassword;
                    needsRelogin = true;
                }

                saveAuthUsers(currentAuthUsers); // Save updated auth users
                updateUserProfileData(oldEmail, currentUserProfile); // Save updated profile data (using oldEmail as key to manage potential key change)

                displayMessage(settingsMessageDiv, 'Profile updated successfully!', 'success', 'fas fa-check-circle');

                // Re-render dashboard header to update username display if it changed
                setTimeout(() => {
                    toggleModal(settingsModal, false); // Close modal
                    if (needsRelogin) {
                        navigateTo('login', 'Your account details have been updated. Please log in with your new credentials.', 'info', 'fas fa-lock');
                    } else {
                        // If only username changed, the welcomeMessageSpan update above already handles this.
                        // No full re-render is needed unless other elements depend on the 'userEmail' var.
                        // Since this is a client-side app, 'userEmail' here is already updated.
                    }
                }, 1500); // Give user time to see the success message
            };


            /**
             * Handles initiating the user verification process.
             */
            const handleInitiateVerification = () => {
                let userData = getUserProfileData(userEmail); // Use userEmail for data retrieval
                if (userData.verificationStatus === 'unverified') {
                    userData.verificationStatus = 'pending';
                    updateUserProfileData(userEmail, userData); // Save using email as key
                    updateVerificationStatusDisplay(userData.verificationStatus);
                    displayMessage(settingsMessageDiv, 'Verification initiated! Please check your email for further instructions.', 'info', 'fas fa-info-circle');
                } else if (userData.verificationStatus === 'pending') {
                    displayMessage(settingsMessageDiv, 'Verification is already pending. Please wait for our team to review.', 'info', 'fas fa-info-circle');
                } else if (userData.verificationStatus === 'verified') {
                    displayMessage(settingsMessageDiv, 'Your profile is already verified.', 'success', 'fas fa-check-circle');
                }
            };

            // --- Event Listeners (Dashboard Scope) ---
            logoutButton.addEventListener('click', handleLogout);
            settingsButton.addEventListener('click', showSettingsModal);
            payInBtn.addEventListener('click', handleAddFunds);
            withdrawBtn.addEventListener('click', handleWithdrawalClick); // New: Event listener for withdrawal button
            withdrawalForm.addEventListener('submit', handleWithdrawal); // New: Event listener for withdrawal form submission
            cancelWithdrawalBtn.addEventListener('click', () => toggleModal(withdrawalModal, false)); // New: Cancel withdrawal modal

            marketInsightsBtn.addEventListener('click', () => showAiInsightModal('Market Overview'));

            calculateReturnsBtn.addEventListener('click', calculateReturns);
            investmentAmountInput.addEventListener('input', calculateReturns); // Recalculate on amount change
            investmentDurationValueInput.addEventListener('input', calculateReturns); // Recalculate on duration change
            investmentDurationUnitSelect.addEventListener('change', calculateReturns); // Recalculate on unit change
            investmentOpportunitySelect.addEventListener('change', calculateReturns); // Recalculate on opportunity change

            proceedToInvestBtn.addEventListener('click', handleProceedToInvest);
            cancelInvestmentBtn.addEventListener('click', () => toggleModal(investmentConfirmationModal, false));
            confirmInvestmentBtn.addEventListener('click', handleConfirmInvestment);
            cancelButtonPaymentInstructionsBtn.addEventListener('click', () => toggleModal(paymentInstructionsModal, false));

            // Event listener for "I Have Paid" button (for Add Funds)
            confirmPaymentReceivedBtn.addEventListener('click', () => {
                toggleModal(paymentInstructionsModal, false);
                let userData = getUserProfileData(userEmail); // Use userEmail for data retrieval
                userData.balance += currentAddFundsAmount;
                updateUserProfileData(userEmail, userData); // Save using email as key
                updatePortfolioOverview();
                successTransactionTypeSpan.textContent = 'funds addition';
                toggleModal(paymentSuccessModal, true);
                addFundsAmountInput.value = ''; // Clear input
            });

            closeSuccessModalBtn.addEventListener('click', () => toggleModal(paymentSuccessModal, false));
            closeAiInsightModalBtn.addEventListener('click', () => toggleModal(aiInsightModal, false));
            
            // Settings Form Event Listeners
            settingsForm.addEventListener('submit', handleUpdateProfile); // Changed to listen to form submit
            initiateVerificationBtn.addEventListener('click', handleInitiateVerification); // Still a button click
            closeSettingsModalBtn.addEventListener('click', () => toggleModal(settingsModal, false));

            // Initial calls on dashboard load
            calculateReturns(); // Run calculator on load
            updatePortfolioOverview(); // Populate stats on load
            initializeInvestmentChart(); // Initialize the chart
            renderActiveInvestments(); // Render active investments list
            
            // Start simulation interval only if it's not already running
            if (!simulationIntervalId) {
                simulationIntervalId = setInterval(simulateInvestmentGrowth, SIMULATION_INTERVAL_MS);
            }
        }


        // --- Global Navigation & Authentication Logic ---

        /**
         * Navigates to a specific page.
         * @param {string} page - The page to navigate to ('signup', 'login', 'dashboard').
         * @param {string} message - Optional message to pass to the page.
         * @param {string} type - Type of message ('success', 'error', 'info').
         * @param {string} icon - Font Awesome icon class for the message.
         */
        function navigateTo(page, message = '', type = '', icon = '') {
            // Clear any lingering modals from previous views
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.classList.remove('active'));

            // Clear simulation interval when navigating away from dashboard
            if (simulationIntervalId) {
                clearInterval(simulationIntervalId);
                simulationIntervalId = null;
            }
            // Destroy chart instance when navigating away
            if (investmentChart) {
                investmentChart.destroy();
                investmentChart = null;
            }


            switch (page) {
                case 'signup':
                    renderSignUpPage(message, type, icon);
                    break;
                case 'login':
                    renderLoginPage(message, type, icon);
                    break;
                case 'dashboard':
                    const loggedInUserEmail = localStorage.getItem(`${APP_ID}-loggedInUserEmail`);
                    if (loggedInUserEmail) {
                        // Update last login time for the user
                        let usersData = getUsersData();
                        if (usersData[loggedInUserEmail]) {
                            usersData[loggedInUserEmail].lastLogin = new Date().toISOString();
                            saveUsersData(usersData);
                        }
                        renderDashboardPage(loggedInUserEmail);
                    } else {
                        // If no user is logged in, redirect to login
                        navigateTo('login', 'Please log in to view your dashboard.', 'error', 'fas fa-lock');
                    }
                    break;
                default:
                    renderSignUpPage(); // Default to signup page
            }
        }

        /**
         * Handles the sign-up form submission.
         */
        async function handleSignUp(event) {
            event.preventDefault();
            const emailInput = document.getElementById('signupEmail');
            const usernameInput = document.getElementById('signupUsername');
            const passwordInput = document.getElementById('signupPassword');
            const authMessageDiv = document.getElementById('authMessage');

            const email = emailInput.value.trim().toLowerCase();
            const username = usernameInput.value.trim(); // Optional username
            const password = passwordInput.value.trim();

            if (!email || !password) {
                displayMessage(authMessageDiv, 'Please enter both email and password.', 'error', 'fas fa-exclamation-triangle');
                return;
            }
            if (!/\S+@\S+\.\S+/.test(email)) { // Basic email validation
                displayMessage(authMessageDiv, 'Please enter a valid email address.', 'error', 'fas fa-exclamation-triangle');
                return;
            }
            if (password.length < 6) { // Basic password length validation
                displayMessage(authMessageDiv, 'Password must be at least 6 characters long.', 'error', 'fas fa-exclamation-triangle');
                return;
            }

            toggleSpinner(true, 'Creating your account...');

            // Simulate network delay for spinner
            await new Promise(resolve => setTimeout(resolve, 1500));

            let existingAuthUsers = getAuthUsers();
            if (existingAuthUsers[email]) {
                toggleSpinner(false);
                displayMessage(authMessageDiv, 'An account with this email already exists. Please log in or use a different email.', 'error', 'fas fa-exclamation-triangle');
                return;
            }

            // Store user credentials (in a real app, passwords MUST be hashed and securely stored on a server)
            existingAuthUsers[email] = { password: password, username: username }; // Store password and optional username
            saveAuthUsers(existingAuthUsers);

            // Initialize user data (balance, investments, etc.) for the new user using email as key
            const initialUserProfileData = {
                username: username || email.split('@')[0], // Use provided username or derive from email
                email: email,
                balance: 0,
                totalInvested: 0,
                estimatedTotalReturns: 0,
                verificationStatus: 'unverified',
                registrationDate: new Date().toISOString(), // Capture registration date
                lastLogin: null, // Will be set on first successful login
                activeInvestments: [] // Initialize empty array for new user
            };
            updateUserProfileData(email, initialUserProfileData);

            // Clear form fields
            emailInput.value = '';
            usernameInput.value = '';
            passwordInput.value = '';

            toggleSpinner(false);
            navigateTo('login', 'Account created successfully! Please log in.', 'success', 'fas fa-check-circle');
        }

        /**
         * Handles the login form submission.
         */
        async function handleLogin(event) {
            event.preventDefault();
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            const authMessageDiv = document.getElementById('authMessage');

            const email = emailInput.value.trim().toLowerCase();
            const password = passwordInput.value.trim();

            if (!email || !password) {
                displayMessage(authMessageDiv, 'Please enter both email and password.', 'error', 'fas fa-exclamation-triangle');
                return;
            }

            toggleSpinner(true, 'Logging in...');
            // Simulate network delay for spinner
            await new Promise(resolve => setTimeout(resolve, 1500));

            const storedAuthUsers = getAuthUsers();
            const userCredentials = storedAuthUsers[email];

            if (userCredentials && userCredentials.password === password) {
                localStorage.setItem(`${APP_ID}-loggedInUserEmail`, email); // Store email as logged in user

                // Update lastLogin for the user on successful login
                let usersData = getUsersData();
                if (usersData[email]) {
                    usersData[email].lastLogin = new Date().toISOString();
                } else {
                    // This case should ideally not happen if signup works, but for robustness
                    usersData[email] = {
                        username: email.split('@')[0],
                        email: email,
                        balance: 0,
                        totalInvested: 0,
                        estimatedTotalReturns: 0,
                        verificationStatus: 'unverified',
                        registrationDate: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        activeInvestments: [] // Ensure this is initialized even if user data was missing
                    };
                }
                saveUsersData(usersData);

                toggleSpinner(false);
                navigateTo('dashboard');
            } else {
                toggleSpinner(false);
                displayMessage(authMessageDiv, 'Invalid email or password. Please try again.', 'error', 'fas fa-times-circle');
            }
        }

        /**
         * Handles the logout action.
         */
        function handleLogout() {
            localStorage.removeItem(`${APP_ID}-loggedInUserEmail`);
            navigateTo('login', 'You have been logged out.', 'success', 'fas fa-sign-out-alt');
        }

        // --- Initial Application Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const loggedInUserEmail = localStorage.getItem(`${APP_ID}-loggedInUserEmail`);
            if (loggedInUserEmail) {
                navigateTo('dashboard');
            } else {
                navigateTo('signup'); // Start with the signup page if not logged in
            }
        });

        // Make copyToClipboard globally accessible for the button in the modal HTML
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>